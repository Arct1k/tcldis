<html>
<head>
    <meta charset="utf-8">
    <script src="tcldis/web/react-0.12.2.min.js"></script>
    <link  href="tcldis/web/style.css" rel="stylesheet" type="text/css">
    <script src="script.min.js"></script>
    <script src="tcldis.js"></script>
</head>
<body>
<div id="tcldis"></div>
<pre style="display: none;" id="initial_code"># Example code to decompile
set x 5
puts 1
if {$x &lt; 15} {
    puts 1
}
puts 2
foreach {a b} [list 1 2 3 4] {
    puts [expr {$a + $b}]
}
puts 3
if {[catch {my_buggy_proc} err]} {
    puts $err
}
puts 4
</pre>
<script>
'use strict';

var decompile;
setTimeout(function () {
    empython.Initialize();
    decompile = empython.Module.cwrap('emtcldis_decompile', 'string', ['string']);
}, 0);
setTimeout(function () {
    empython.Module.ccall('emtcldis_init', 'number', [], []);
}, 0);

function getInitialCode(cb) {
    setTimeout(function () {
        cb(null, document.getElementById('initial_code').textContent);
    }, 0);
}

function getDecompileSteps(code, cb) {
    // This setTimeout serves a dual purpose. It
    // 1. makes sure that the call to getDecompileSteps is async
    // 2. ensures that empython initialize and emtcldis_init above have run
    setTimeout(function () {
        var decompiled = JSON.parse(decompile('proc p {} {\n' + code + '\n}'));
        cb(null, {'steps': decompiled[0], 'changes': decompiled[1]});
    }, 0);
}

React.render(
    React.createElement(TclDisUI, null),
    document.getElementById('tcldis')
);
</script>
</body>
</html>
